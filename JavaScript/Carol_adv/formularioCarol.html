<!DOCTYPE html>
<html lang="pt-br">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Preencher Formulário com CSV</title>
  <script src="https://cdnjs.cloudflare.com/ajax/ajax/libs/PapaParse/5.3.0/papaparse.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/pdf-lib/dist/pdf-lib.min.js"></script>
</head>
<body>
<h1>Formulário Preenchido com Dados CSV</h1>

<!-- Input de Arquivo para Selecionar o CSV -->
<input type="file" id="fileInput" accept=".csv">

<!-- Tabela para mostrar os dados -->
<h2>Dados Preenchidos</h2>
<table id="tabelaDados" border="1" style="display:none;">
  <thead>
  <tr>
    <th>Tipo</th>
    <th>Nome</th>
    <th>Nome 2</th>
    <th>Registro Civil</th>
    <th>Livro</th>
    <th>Folha</th>
    <th>Termo</th>
    <th>Ação</th>
  </tr>
  </thead>
  <tbody></tbody>
</table>

<script>
  // Função para lidar com o arquivo CSV selecionado
  document.getElementById('fileInput').addEventListener('change', function(event) {
    const file = event.target.files[0];

    if (file) {
      const reader = new FileReader();
      reader.onload = function(e) {
        const csvText = e.target.result;
        // Processa o CSV com PapaParse
        Papa.parse(csvText, {
          delimiter: ";",
          skipEmptyLines: true,
          complete: function(results) {
            preencherTabela(results.data);
          }
        });
      };
      reader.readAsText(file);
    }
  });

  // Função para preencher a tabela com os dados do CSV
  function preencherTabela(dadosCSV) {
    const tabela = document.getElementById("tabelaDados").getElementsByTagName("tbody")[0];

    dadosCSV.forEach((registro) => {
      const novaLinha = tabela.insertRow();

      novaLinha.insertCell(0).textContent = registro[0]; // Tipo
      novaLinha.insertCell(1).textContent = registro[1]; // Nome
      novaLinha.insertCell(2).textContent = registro[2] || ''; // Nome 2
      novaLinha.insertCell(3).textContent = registro[3]; // Registro Civil
      novaLinha.insertCell(4).textContent = registro[4]; // Livro
      novaLinha.insertCell(5).textContent = registro[5]; // Folha
      novaLinha.insertCell(6).textContent = registro[6]; // Termo

      // Adiciona botão para gerar PDF
      const acaoCell = novaLinha.insertCell(7);
      const btnGerarPDF = document.createElement("button");
      btnGerarPDF.textContent = "Gerar PDF";
      btnGerarPDF.onclick = function () {
        gerarPDF(registro);
      };
      acaoCell.appendChild(btnGerarPDF);
    });

    document.getElementById("tabelaDados").style.display = "table";
  }

  // Função para gerar o PDF com os dados da pessoa
  async function gerarPDF(dados) {
    const url = 'https://ssabat.infinityfreeapp.com/JavaScript/Carol_adv/24_Requerimento-InteiroTeor_TESTE2.pdf';
    const existingPdfBytes = await fetch(url).then(res => res.arrayBuffer());

    const pdfDoc = await PDFLib.PDFDocument.load(existingPdfBytes);
    const form = pdfDoc.getForm();

    try {
      const tipo = dados[0].toLowerCase(); // Tipo do CSV

      if (tipo === 'nascimento') {
        form.getTextField('tipo1').setText('NASCIMENTO'); // Preenche o tipo
        form.getTextField('nome1').setText(dados[1]); // Nome
        form.getTextField('termo1').setText(dados[6]); // Termo
        form.getTextField('folha1').setText(dados[5]); // Folha
        form.getTextField('livro1').setText(dados[4]); // Livro
      } else if (tipo === 'casamento') {
        form.getTextField('tipo2').setText('CASAMENTO'); // Preenche o tipo
        form.getTextField('nome12').setText(dados[1]); // Primeiro Nome
        form.getTextField('nome2').setText(dados[2]); // Segundo Nome
        form.getTextField('termo2').setText(dados[6]); // Termo
        form.getTextField('folha2').setText(dados[5]); // Folha
        form.getTextField('livro2').setText(dados[4]); // Livro
      } else if (tipo === 'óbito') {
        form.getTextField('tipo3').setText('ÓBITO'); // Preenche o tipo
        form.getTextField('nome3').setText(dados[1]); // Nome
        form.getTextField('termo3').setText(dados[6]); // Termo
        form.getTextField('folha3').setText(dados[5]); // Folha
        form.getTextField('livro3').setText(dados[4]); // Livro
      } else {
        alert('Tipo desconhecido: ' + tipo);
        return;
      }

      const pdfBytes = await pdfDoc.save();

      // Baixa o PDF gerado
      const link = document.createElement('a');
      link.href = URL.createObjectURL(new Blob([pdfBytes], { type: 'application/pdf' }));
      link.download = `formulario_preenchido_${tipo}.pdf`;
      link.click();
    } catch (error) {
      console.error('Erro ao preencher os campos do PDF:', error.message);
      alert('Erro: Verifique se os campos do PDF estão corretos.');
    }
  }
</script>
</body>
</html>
